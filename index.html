<!DOCTYPE html>
<html lang="pl">
<head>
<meta charset="UTF-8">
<title>Tablica Online Realtime - MultiPage</title>
<style>
body { margin:0; overflow:hidden; font-family: sans-serif; }
#toolbar {
  position: fixed; top:0; left:0; right:0; height:50px;
  background:#ddd; display:flex; align-items:center; padding:5px; z-index:100;
}
canvas { position:absolute; top:50px; left:0; cursor:crosshair; }
button,input { margin-right:5px; }
</style>
</head>
<body>

<div id="toolbar">
  <button onclick="setDrawMode('draw')">Rysowanie</button>
  <button onclick="setDrawMode('select')">Zaznaczanie</button>
  <button onclick="setColor('black')">Czarny</button>
  <button onclick="setColor('red')">Czerwony</button>
  <button onclick="setColor('blue')">Niebieski</button>
  <label>Grubość:</label>
  <input type="range" id="size" min="1" max="50" value="5" onchange="setSize(this.value)">
  <button onclick="undo()">Cofnij</button>
  <button onclick="addPage()">Dodaj stronę</button>
  <button onclick="deletePage()">Usuń stronę</button>
  <button onclick="renamePage()">Zmień nazwę strony</button>
  <select id="pageSelector" onchange="switchPage(this.value)"></select>
  <button onclick="savePDF()">Zapisz do PDF</button>
  <input type="file" id="imgUpload" onchange="addImage(this.files[0])">
</div>

<canvas id="canvas"></canvas>

<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<script>
// ---------------- Firebase ----------------
const firebaseConfig = {
  apiKey: "AIzaSyAU-m6n4AURX1VQL6BvKQKmA03WISQctgo",
  authDomain: "tablica-web.firebaseapp.com",
  databaseURL: "https://tablica-web-default-rtdb.firebaseio.com",
  projectId: "tablica-web",
  storageBucket: "tablica-web.appspot.com",
  messagingSenderId: "497248912756",
  appId: "1:497248912756:web:45894617e7de8bcdf15821"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();
const pagesRef = db.ref('pages');
const cursorsRef = db.ref('cursors');

// ---------------- Canvas ----------------
const canvas = document.getElementById("canvas");
const ctx = canvas.getContext("2d");
let drawMode='draw', drawing=false, color='black', size=5;
let startX, startY;
let objects=[], currentPage=null, selectedObjects=[];
let isShift=false;
let dragOffsetX=0, dragOffsetY=0;
let lassoStart=null, lassoRect=null;
let userId = 'user_'+Math.floor(Math.random()*1000000);

// ---------------- Resize ----------------
function resizeCanvas(){
  canvas.width = window.innerWidth;
  canvas.height = window.innerHeight - 50;
  redraw();
}
window.addEventListener('resize', resizeCanvas);

// ---------------- Pages ----------------
let pages=[];
function loadPages(){
  pagesRef.on('value', snap=>{
    pages = snap.val() || [];
    updatePageSelector();
    if(!currentPage && pages.length) currentPage=pages[0].id;
    loadObjects();
  });
}
function updatePageSelector(){
  const sel = document.getElementById('pageSelector');
  sel.innerHTML='';
  pages.forEach(p=>{
    const opt=document.createElement('option');
    opt.value=p.id;
    opt.text=p.name;
    if(p.id===currentPage) opt.selected=true;
    sel.appendChild(opt);
  });
}
function switchPage(id){
  currentPage=id;
  loadObjects();
}
function addPage(){
  const name = prompt("Nazwa nowej strony","Strona "+(pages.length+1));
  if(!name) return;
  const id = 'page_'+Date.now();
  pages.push({id,name});
  pagesRef.set(pages);
}
function deletePage(){
  if(!currentPage) return;
  if(!confirm("Usunąć stronę?")) return;
  pages = pages.filter(p=>p.id!==currentPage);
  pagesRef.set(pages);
  const objRef = db.ref('objects/'+currentPage);
  objRef.remove();
  currentPage = pages.length?pages[0].id:null;
  updatePageSelector();
  loadObjects();
}
function renamePage(){
  if(!currentPage) return;
  const p = pages.find(p=>p.id===currentPage);
  const newName = prompt("Nowa nazwa strony", p.name);
  if(!newName) return;
  p.name = newName;
  pagesRef.set(pages);
}
function loadObjects(){
  if(!currentPage) return;
  db.ref('objects/'+currentPage).on('value', snap=>{
    objects = snap.val()||[];
    redraw();
  });
}
function saveObjects(){ if(currentPage) db.ref('objects/'+currentPage).set(objects); }

// ---------------- Cursor ----------------
function updateCursor(){
  cursorsRef.child(userId).set({timestamp:Date.now(), x:0, y:0});
  setTimeout(updateCursor,1000);
}
updateCursor();
cursorsRef.on('value', snap=>{
  redraw();
});

// ---------------- Mouse ----------------
canvas.addEventListener('mousedown', e=>{
  const rect=canvas.getBoundingClientRect();
  const x=e.clientX-rect.left;
  const y=e.clientY-rect.top;

  if(drawMode==='draw'){
    drawing=true;
    startX=x; startY=y;
    const line={type:'line',color,size,points:[{x,y}]};
    objects.push(line);
  }else if(drawMode==='select'){
    lassoStart={x,y};
    lassoRect=null;
    selectedObjects=[];
    objects.forEach(o=>o.selected=false);
  }
});

canvas.addEventListener('mousemove', e=>{
  const rect=canvas.getBoundingClientRect();
  const x=e.clientX-rect.left;
  const y=e.clientY-rect.top;

  cursorsRef.child(userId).set({x,y,timestamp:Date.now()});

  if(drawMode==='draw' && drawing){
    const obj=objects[objects.length-1];
    if(isShift){
      obj.points.splice(1,obj.points.length-1);
      obj.points.push({x,y});
    }else obj.points.push({x,y});
    redraw();
  }else if(drawMode==='select' && lassoStart){
    lassoRect={x1:lassoStart.x, y1:lassoStart.y, x2:x, y2:y};
    redraw();
  }
});

canvas.addEventListener('mouseup', e=>{
  drawing=false;
  if(drawMode==='select' && lassoRect){
    const xMin=Math.min(lassoRect.x1, lassoRect.x2);
    const xMax=Math.max(lassoRect.x1, lassoRect.x2);
    const yMin=Math.min(lassoRect.y1, lassoRect.y2);
    const yMax=Math.max(lassoRect.y1, lassoRect.y2);
    objects.forEach(o=>{
      if(o.type==='image'){
        if(o.x+o.w>=xMin && o.x<=xMax && o.y+o.h>=yMin && o.y<=yMax){
          o.selected=true; selectedObjects.push(o);
        }
      }else if(o.type==='line'){
        const minX=Math.min(...o.points.map(p=>p.x));
        const maxX=Math.max(...o.points.map(p=>p.x));
        const minY=Math.min(...o.points.map(p=>p.y));
        const maxY=Math.max(...o.points.map(p=>p.y));
        if(maxX>=xMin && minX<=xMax && maxY>=yMin && minY<=yMax){
          o.selected=true; selectedObjects.push(o);
        }
      }
    });
    lassoStart=null; lassoRect=null;
    redraw();
  }
  saveObjects();
});

// ---------------- Key ----------------
window.addEventListener('keydown', e=>{
  if(e.key==='Delete' && selectedObjects.length){
    objects=objects.filter(o=>!selectedObjects.includes(o));
    selectedObjects=[];
    saveObjects();
    redraw();
  }
  if(e.key==='Shift') isShift=true;
});
window.addEventListener('keyup', e=>{ if(e.key==='Shift') isShift=false; });

// ---------------- Toolbar ----------------
function setDrawMode(mode){ drawMode=mode; selectedObjects=[]; redraw();}
function setColor(c){ color=c; }
function setSize(s){ size=parseInt(s); }
function undo(){ objects.pop(); saveObjects(); redraw(); }

// ---------------- Images ----------------
function addImage(file){
  const reader=new FileReader();
  reader.onload=function(e){
    const img=new Image(); img.src=e.target.result;
    img.onload=function(){
      const obj={type:'image',img:e.target.result,x:50,y:50,w:img.width/2,h:img.height/2};
      objects.push(obj); saveObjects(); redraw();
    }
  }; reader.readAsDataURL(file);
}
window.addEventListener('paste', e=>{
  const items=e.clipboardData.items;
  for(let i=0;i<items.length;i++){
    if(items[i].type.indexOf("image")!==-1){
      const blob=items[i].getAsFile();
      const reader=new FileReader();
      reader.onload=function(ev){
        const img=new Image(); img.src=ev.target.result;
        img.onload=function(){
          const obj={type:'image',img:ev.target.result,x:50,y:50,w:img.width/2,h:img.height/2};
          objects.push(obj); saveObjects(); redraw();
        }
      }; reader.readAsDataURL(blob);
    }
  }
});

// ---------------- PDF ----------------
function savePDF(){
  html2canvas(canvas).then(canvasImg=>{
    const imgData = canvasImg.toDataURL('image/png');
    const pdf = new jspdf.jsPDF({orientation:'landscape',unit:'px',format:[canvas.width,canvas.height]});
    pdf.addImage(imgData,'PNG',0,0,canvas.width,canvas.height);
    pdf.save('tablica.pdf');
  });
}

// ---------------- Redraw ----------------
function redraw(){
  drawGrid();
  objects.forEach(o=>{
    if(o.type==='line'){
      ctx.beginPath();
      ctx.moveTo(o.points[0].x,o.points[0].y);
      for(let p of o.points) ctx.lineTo(p.x,p.y);
      ctx.strokeStyle=o.color;
      ctx.lineWidth=o.size;
      ctx.lineCap='round'; ctx.lineJoin='round';
      ctx.stroke();
      if(o.selected){
        const minX=Math.min(...o.points.map(p=>p.x));
        const maxX=Math.max(...o.points.map(p=>p.x));
        const minY=Math.min(...o.points.map(p=>p.y));
        const maxY=Math.max(...o.points.map(p=>p.y));
        ctx.strokeStyle='blue'; ctx.lineWidth=2;
        ctx.strokeRect(minX,minY,maxX-minX,maxY-minY);
      }
    }else if(o.type==='image'){
      const img=o.img instanceof Image?o.img:(()=>{let i=new Image();i.src=o.img; return i;})();
      ctx.drawImage(img,o.x,o.y,o.w,o.h);
      if(o.selected){
        ctx.strokeStyle='blue'; ctx.lineWidth=2;
        ctx.strokeRect(o.x,o.y,o.w,o.h);
      }
    }
  });
  // rysowanie lasso
  if(lassoRect){
    const xMin=Math.min(lassoRect.x1,lassoRect.x2);
    const xMax=Math.max(lassoRect.x1,lassoRect.x2);
    const yMin=Math.min(lassoRect.y1,lassoRect.y2);
    const yMax=Math.max(lassoRect.y1,lassoRect.y2);
    ctx.strokeStyle='red'; ctx.lineWidth=1; ctx.setLineDash([5,3]);
    ctx.strokeRect(xMin,yMin,xMax-xMin,yMax-yMin);
    ctx.setLineDash([]);
  }
  // cursors
  const now=Date.now();
  for(let key in cursors){
    const c=cursors[key];
    if(now-c.timestamp>3000) continue; // wygaszenie
    ctx.beginPath();
    ctx.arc(c.x,c.y,5,0,Math.PI*2);
    ctx.fillStyle=key===userId?'green':'red';
    ctx.fill();
  }
}

resizeCanvas();
loadPages();
</script>
</body>
</html>
