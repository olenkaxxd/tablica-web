<!DOCTYPE html>
<html lang="pl">
<head>
<meta charset="UTF-8">
<title>Tablica Online – Nauczyciel i Uczniowie</title>
<style>
body { margin:0; overflow:hidden; font-family:sans-serif; }
#toolbar {
  position: fixed; top:0; left:0; right:0; height:50px;
  background:#ddd; display:flex; align-items:center; padding:5px; z-index:100;
}
canvas { position:absolute; top:50px; left:0; cursor:crosshair; }
button,input,select { margin-right:5px; }
#pageName { margin-left:10px; font-weight:bold; }
</style>
</head>
<body>

<div id="toolbar">
  <button onclick="setDrawMode('draw')">Rysowanie</button>
  <button onclick="setDrawMode('select')">Zaznaczanie</button>
  <button onclick="setColor('black')">Czarny</button>
  <button onclick="setColor('red')">Czerwony</button>
  <button onclick="setColor('blue')">Niebieski</button>
  <label>Grubość:</label>
  <input type="range" id="size" min="1" max="30" value="5" onchange="setSize(this.value)">
  <button onclick="undo()">Cofnij</button>
  <button onclick="addPage()">Dodaj stronę</button>
  <button onclick="deletePage()">Usuń stronę</button>
  <button onclick="renamePage()">Zmień nazwę</button>
  <button onclick="clearPage()">Wyczyść stronę</button>
  <select id="pageSelector" onchange="switchPage(this.value)"></select>
  <span id="pageName"></span>
  <button onclick="savePDF()">Zapisz do PDF</button>
  <input type="file" id="imgUpload" onchange="addImage(this.files[0])">
  <select id="boardSelector" style="display:none;" onchange="switchBoard(this.value)"></select>
</div>

<canvas id="canvas"></canvas>

<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<script>
// ---------------- Firebase ----------------
const firebaseConfig = {
  apiKey: "AIzaSyAU-m6n4AURX1VQL6BvKQKmA03WISQctgo",
  authDomain: "tablica-web.firebaseapp.com",
  databaseURL: "https://tablica-web-default-rtdb.firebaseio.com",
  projectId: "tablica-web"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

// ---------------- Users / Boards ----------------
const students = ["adam_lewicki","adam_prochera","klara_los","maciej_pawlowski","nina_bielecka","robert_los","kinga_tkaczyk"];
let boardId = new URLSearchParams(window.location.search).get('board') || 'teacher';
const isTeacher = boardId==='teacher';

// ---------------- Canvas ----------------
const canvas = document.getElementById('canvas');
const ctx = canvas.getContext('2d');
let drawMode='draw', drawing=false, color='black', size=5;
let objects=[], pages=[], currentPage=null, selectedObjects=[];
let draggingObject=null, dragOffsetX=0, dragOffsetY=0;
let dragHandle=null, dragStart=null, lastMousePos=null, isShift=false;
const userId = 'u'+Math.random().toString(36).slice(2);

let pagesRef = db.ref('boards/'+boardId+'/pages');
let cursorsRef = db.ref('boards/'+boardId+'/cursors');

// ---------------- Resize ----------------
function resizeCanvas(){
  canvas.width = window.innerWidth;
  canvas.height = window.innerHeight - 50;
  redraw();
}
window.addEventListener('resize', resizeCanvas);
resizeCanvas();

// ---------------- Cursor ----------------
function updateCursorPosition(x,y){
  cursorsRef.child(userId).set({x,y,timestamp:Date.now()});
}
setInterval(()=>{
  cursorsRef.child(userId).update({timestamp:Date.now()});
},1000);
function redrawCursors(cursors){
  const now = Date.now();
  for(let key in cursors){
    const c = cursors[key];
    if(now-c.timestamp>3000){ cursorsRef.child(key).remove(); continue; }
    ctx.beginPath();
    ctx.arc(c.x,c.y,5,0,Math.PI*2);
    ctx.fillStyle = key===userId?'green':'red';
    ctx.fill();
  }
}

// ---------------- Boards Dropdown ----------------
if(isTeacher){
  const sel = document.getElementById('boardSelector');
  sel.style.display='inline';
  const opts = [{id:'teacher',name:'Nauczyciel'}, ...students.map(s=>({id:s,name:s}))];
  opts.forEach(o=>{
    const option=document.createElement('option');
    option.value=o.id; option.text=o.name;
    if(o.id===boardId) option.selected=true;
    sel.appendChild(option);
  });
}
function switchBoard(id){
  boardId=id;
  pagesRef=db.ref('boards/'+boardId+'/pages');
  cursorsRef=db.ref('boards/'+boardId+'/cursors');
  loadPages();
}

// ---------------- Pages ----------------
function loadPages(){
  pagesRef.on('value', snap=>{
    pages = snap.val() || [];
    if(!currentPage && pages.length) currentPage = pages[0]?.id || null;
    updatePageSelector();
    loadObjects();
  });
}
function updatePageSelector(){
  const sel = document.getElementById('pageSelector');
  sel.innerHTML='';
  pages.forEach(p=>{
    const o=document.createElement('option');
    o.value=p.id; o.text=p.name;
    if(p.id===currentPage) o.selected=true;
    sel.appendChild(o);
  });
  document.getElementById('pageName').textContent = pages.find(p=>p.id===currentPage)?.name||'';
}
function addPage(){
  const name = prompt("Nazwa nowej strony","Strona "+(pages.length+1));
  if(!name) return;
  const id = 'page_'+Date.now();
  pages.push({id,name});
  pagesRef.set(pages);
  currentPage=id;
  objects=[];
  saveObjects();
  redraw();
}
function deletePage(){
  if(!currentPage || !confirm("Usunąć stronę?")) return;
  pages = pages.filter(p=>p.id!==currentPage);
  pagesRef.set(pages);
  db.ref('boards/'+boardId+'/objects/'+currentPage).remove();
  currentPage = pages[0]?.id || null;
  objects=[];
  redraw();
}
function renamePage(){
  const p = pages.find(p=>p.id===currentPage);
  const n = prompt("Nowa nazwa",p.name);
  if(n){ p.name=n; pagesRef.set(pages); }
}
function clearPage(){
  if(!currentPage || !confirm("Wyczyścić stronę?")) return;
  objects=[];
  saveObjects();
  redraw();
}
function switchPage(id){
  currentPage=id;
  loadObjects();
}

// ---------------- Objects ----------------
function loadObjects(){
  if(!currentPage) return;
  db.ref('boards/'+boardId+'/objects/'+currentPage).on('value', snap=>{
    objects = snap.val() || [];
    redraw();
  });
}
function saveObjects(){
  if(currentPage) db.ref('boards/'+boardId+'/objects/'+currentPage).set(objects);
}

// ---------------- Mouse ----------------
canvas.addEventListener('mousedown', e=>{
  const r=canvas.getBoundingClientRect();
  const x=e.clientX-r.left;
  const y=e.clientY-r.top;
  lastMousePos={x,y};

  // handle scale/rotate handles
  for(let o of selectedObjects){
    for(let h of getHandles(o)){
      if(Math.abs(x-h.x)<6 && Math.abs(y-h.y)<6){
        dragHandle={o,type:h.type};
        dragStart={x,y,scale:o.scaleX,rot:o.rotation};
        return;
      }
    }
  }

  // select image
  let clicked=false;
  for(let o of objects){
    if(o.type==='image'){
      const cx=o.x+o.w/2, cy=o.y+o.h/2;
      if(Math.abs(x-cx)<=o.w*o.scaleX/2 && Math.abs(y-cy)<=o.h*o.scaleY/2){
        selectedObjects=[o]; o.selected=true;
        draggingObject=o;
        dragOffsetX=x-(o.x+o.w/2); dragOffsetY=y-(o.y+o.h/2);
        redraw(); clicked=true; break;
      }
    }
  }
  if(clicked) return;

  selectedObjects=[]; objects.forEach(o=>o.selected=false);
  if(drawMode==='draw'){
    drawing=true;
    objects.push({type:'line',color,size,points:[{x,y}]});
  }
});

canvas.addEventListener('mousemove', e=>{
  const r=canvas.getBoundingClientRect();
  const x=e.clientX-r.left;
  const y=e.clientY-r.top;
  lastMousePos={x,y};

  if(dragHandle){
    const o=dragHandle.o;
    if(dragHandle.type==='scale'){
      const cx=o.x+o.w/2, cy=o.y+o.h/2;
      const s=Math.hypot(x-cx,y-cy)/Math.hypot(dragStart.x-cx,dragStart.y-cy);
      o.scaleX=o.scaleY=Math.max(0.1,dragStart.scale*s);
    }
    if(dragHandle.type==='rotate'){
      o.rotation = dragStart.rot + (x-dragStart.x);
    }
    redraw(); return;
  }

  if(draggingObject){
    draggingObject.x = x - draggingObject.w/2 - dragOffsetX;
    draggingObject.y = y - draggingObject.h/2 - dragOffsetY;
    redraw(); return;
  }

  if(drawing){
    const l=objects.at(-1);
    if(isShift){ l.points=[l.points[0],{x,y}]; } else l.points.push({x,y});
    redraw();
  }

  updateCursorPosition(x,y);
});

canvas.addEventListener('mouseup', e=>{
  drawing=false; draggingObject=null; dragHandle=null;
  saveObjects();
});

// ---------------- Keyboard ----------------
window.addEventListener('keydown', e=>{
  if(e.key==='Delete'){
    objects=objects.filter(o=>!o.selected);
    saveObjects(); redraw();
  }
  if(e.key==='Shift') isShift=true;
});
window.addEventListener('keyup', e=>{ if(e.key==='Shift') isShift=false; });

// ---------------- Drawing ----------------
function setDrawMode(m){ drawMode=m; canvas.style.cursor=m==='draw'?'none':'default'; }
function setColor(c){ color=c; }
function setSize(s){ size=parseInt(s); }
function undo(){ objects.pop(); saveObjects(); redraw(); }

// ---------------- Images ----------------
function addImage(file){
  const r = new FileReader();
  r.onload=e=>{
    const i = new Image();
    i.onload=()=>{
      objects.push({type:'image',img:e.target.result,x:100,y:100,w:i.width/2,h:i.height/2,scaleX:1,scaleY:1,rotation:0});
      saveObjects(); redraw();
    };
    i.src=e.target.result;
  };
  r.readAsDataURL(file);
}
window.addEventListener('paste', e=>{
  for(const i of e.clipboardData.items){
    if(i.type.includes('image')) addImage(i.getAsFile());
  }
});

// ---------------- PDF ----------------
function savePDF(){
  html2canvas(canvas).then(c=>{
    const pdf = new jspdf.jsPDF({unit:'px',format:[canvas.width,canvas.height]});
    pdf.addImage(c.toDataURL(),'PNG',0,0);
    pdf.save('tablica.pdf');
  });
}

// ---------------- Handles ----------------
function getHandles(o){
  if(o.type!=='image') return [];
  const cx=o.x+o.w/2, cy=o.y+o.h/2;
  return [
    {x:cx+o.w*o.scaleX/2, y:cy, type:'scale'},
    {x:cx, y:cy-o.h*o.scaleY/2-20, type:'rotate'}
  ];
}

// ---------------- Grid ----------------
function drawGrid(){
  ctx.fillStyle='#fff'; ctx.fillRect(0,0,canvas.width,canvas.height);
  ctx.strokeStyle='#eee';
  for(let x=0;x<canvas.width;x+=25){
    ctx.beginPath(); ctx.moveTo(x,0); ctx.lineTo(x,canvas.height); ctx.stroke();
  }
  for(let y=0;y<canvas.height;y+=25){
    ctx.beginPath(); ctx.moveTo(0,y); ctx.lineTo(canvas.width,y); ctx.stroke();
  }
}

// ---------------- Redraw ----------------
function redraw(){
  drawGrid();
  objects.forEach(o=>{
    ctx.save();
    if(o.type==='line'){
      ctx.beginPath(); o.points.forEach((p,i)=>i?ctx.lineTo(p.x,p.y):ctx.moveTo(p.x,p.y));
      ctx.strokeStyle=o.color; ctx.lineWidth=o.size; ctx.lineCap='round'; ctx.stroke();
    }
    if(o.type==='image'){
      ctx.translate(o.x+o.w/2, o.y+o.h/2);
      ctx.rotate(o.rotation*Math.PI/180);
      ctx.scale(o.scaleX,o.scaleY);
      const img=new Image(); img.src=o.img;
      ctx.drawImage(img,-o.w/2,-o.h/2,o.w,o.h);
    }
    ctx.restore();
    if(o.selected){ getHandles(o).forEach(h=>{ctx.fillStyle='red'; ctx.fillRect(h.x-4,h.y-4,8,8);}); }
  });

  cursorsRef.once('value', snap=>{
    const cursors = snap.val()||{};
    redrawCursors(cursors);
  });

  if(drawMode==='draw' && lastMousePos){
    ctx.beginPath(); ctx.arc(lastMousePos.x,lastMousePos.y,size/2,0,Math.PI*2);
    ctx.fillStyle=color; ctx.fill();
  }
}

loadPages();
</script>
</body>
</html>
