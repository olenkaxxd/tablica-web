<!DOCTYPE html>
<html lang="pl">
<head>
<meta charset="UTF-8">
<title>Tablica Online</title>

<style>
body { margin:0; overflow:hidden; font-family:Arial; }
#toolbar {
  position:fixed; top:0; left:0; right:0; height:50px;
  background:#ddd; display:flex; align-items:center;
  padding:5px; gap:5px; z-index:100;
}
canvas { position:absolute; top:50px; left:0; }

.cursor-dot {
  position:fixed;
  width:10px; height:10px;
  border-radius:50%;
  pointer-events:none;
  transform:translate(-50%,-50%);
  z-index:999;
}
</style>
</head>

<body>

<div id="toolbar">
  <button onclick="mode='draw'">âœï¸ Rysuj</button>
  <button onclick="mode='select'">ğŸ–±ï¸ Zaznacz</button>
  <input type="color" id="color" value="#000000">
  <input type="range" min="1" max="20" value="4" id="size">
  <button onclick="undo()">â†© Cofnij</button>

  <select id="teacherSelect" style="display:none" onchange="switchStudent(this.value)">
    <option value="">â€” tablica ucznia â€”</option>
  </select>
</div>

<canvas id="canvas"></canvas>
<div id="cursor" class="cursor-dot"></div>

<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

<script>
/* ğŸ”¥ FIREBASE */
firebase.initializeApp({
  apiKey: "AIzaSyAU-m6n4AURX1VQL6BvKQKmA03WISQctgo",
  authDomain: "tablica-web.firebaseapp.com",
  databaseURL: "https://tablica-web-default-rtdb.firebaseio.com",
  projectId: "tablica-web"
});
const db = firebase.database();

/* ğŸ‘©â€ğŸ« UCZNIOWIE */
const students = {
  adam_lewicki: "Adam Lewicki",
  adam_prochera: "Adam Prochera",
  klara_los: "Klara ÅoÅ›",
  maciej_pawlowski: "Maciej PawÅ‚owski",
  nina_bielecka: "Nina Bielecka",
  robert_los: "Robert ÅoÅ›",
  kinga_tkaczyk: "Kinga Tkaczyk"
};

/* ğŸ”‘ TABLICA */
const params = new URLSearchParams(location.search);
let board = params.get("board") || "teacher";
let activeBoard = board;

/* ğŸ‘©â€ğŸ« PANEL NAUCZYCIELA */
if(board === "teacher"){
  const sel = document.getElementById("teacherSelect");
  sel.style.display = "block";
  for(let k in students){
    sel.innerHTML += `<option value="${k}">${students[k]}</option>`;
  }
}

/* ğŸ¨ CANVAS */
const canvas = document.getElementById("canvas");
const ctx = canvas.getContext("2d");
const cursor = document.getElementById("cursor");

function resize(){
  canvas.width = innerWidth;
  canvas.height = innerHeight - 50;
  redraw();
}
addEventListener("resize", resize);
resize();

/* ğŸ§  STAN */
let mode="draw", drawing=false;
let objects=[], selected=null;
let drag=false, startX=0, startY=0;

/* ğŸ”„ DANE */
function load(){
  db.ref("boards/"+activeBoard).on("value", s=>{
    objects = s.val() || [];
    redraw();
  });
}
function save(){
  db.ref("boards/"+activeBoard).set(objects);
}
load();

/* ğŸ–±ï¸ MYSZ */
canvas.onmousedown = e=>{
  const x=e.offsetX, y=e.offsetY;
  if(mode==="select"){
    selected = objects.findLast(o =>
      o.type==="image" &&
      x>o.x && x<o.x+o.w*o.s &&
      y>o.y && y<o.y+o.h*o.s
    );
    drag=!!selected;
    startX=x; startY=y;
  } else {
    drawing=true;
    objects.push({type:"line", color:color.value, size:+size.value, pts:[[x,y]]});
  }
};

canvas.onmousemove = e=>{
  cursor.style.left=e.clientX+"px";
  cursor.style.top=e.clientY+"px";
  cursor.style.background=color.value;
  cursor.style.display = mode==="draw" ? "block":"none";

  if(drawing){
    objects.at(-1).pts.push([e.offsetX,e.offsetY]);
    redraw();
  }
  if(drag && selected){
    selected.x += e.offsetX-startX;
    selected.y += e.offsetY-startY;
    startX=e.offsetX; startY=e.offsetY;
    redraw();
  }
};

canvas.onmouseup = ()=>{
  drawing=false; drag=false;
  save();
};

/* ğŸ“‹ CTRL+V */
addEventListener("paste", e=>{
  for(let i of e.clipboardData.items){
    if(i.type.includes("image")){
      const f=i.getAsFile();
      const r=new FileReader();
      r.onload=ev=>{
        const img=new Image();
        img.onload=()=>{
          objects.push({
            type:"image", img:ev.target.result,
            x:50,y:50,w:img.width/2,h:img.height/2,s:1
          });
          save(); redraw();
        };
        img.src=ev.target.result;
      };
      r.readAsDataURL(f);
    }
  }
});

/* ğŸ§± RYSUJ */
function redraw(){
  ctx.clearRect(0,0,canvas.width,canvas.height);
  for(let o of objects){
    if(o.type==="line"){
      ctx.strokeStyle=o.color;
      ctx.lineWidth=o.size;
      ctx.beginPath();
      o.pts.forEach((p,i)=>i?ctx.lineTo(...p):ctx.moveTo(...p));
      ctx.stroke();
    }
    if(o.type==="image"){
      const img=new Image(); img.src=o.img;
      ctx.drawImage(img,o.x,o.y,o.w*o.s,o.h*o.s);
    }
  }
}

/* ğŸ” */
function undo(){ objects.pop(); save(); redraw(); }
function switchStudent(id){
  if(!id) return;
  db.ref("boards/"+activeBoard).off();
  activeBoard=id;
  load();
}
</script>
</body>
</html>
