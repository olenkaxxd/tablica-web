<!DOCTYPE html>
<html lang="pl">
<head>
<meta charset="UTF-8">
<title>Tablica Online Realtime – Final</title>

<style>
body { margin:0; overflow:hidden; font-family:sans-serif; }
#toolbar {
  position: fixed; top:0; left:0; right:0; height:50px;
  background:#ddd; display:flex; align-items:center; padding:5px; z-index:100;
}
canvas { position:absolute; top:50px; left:0; cursor:default; }
button,input,select { margin-right:5px; }
#pageName { margin-left:10px; font-weight:bold; }
</style>
</head>

<body>

<div id="toolbar">
  <button onclick="setDrawMode('draw')">Rysowanie</button>
  <button onclick="setDrawMode('select')">Zaznaczanie</button>
  <button onclick="setColor('black')">Czarny</button>
  <button onclick="setColor('red')">Czerwony</button>
  <button onclick="setColor('blue')">Niebieski</button>
  <label>Grubość:</label>
  <input type="range" min="1" max="50" value="5" onchange="setSize(this.value)">
  <button onclick="undo()">Cofnij</button>
  <button onclick="addPage()">Dodaj stronę</button>
  <button onclick="deletePage()">Usuń stronę</button>
  <button onclick="renamePage()">Zmień nazwę strony</button>
  <button onclick="clearPage()">Wyczyść stronę</button>
  <select id="pageSelector" onchange="switchPage(this.value)"></select>
  <span id="pageName"></span>
  <button onclick="savePDF()">PDF</button>
  <input type="file" onchange="addImage(this.files[0])">
</div>

<canvas id="canvas"></canvas>

<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<script>
// ---------------- Firebase ----------------
firebase.initializeApp({
  apiKey: "AIzaSyAU-m6n4AURX1VQL6BvKQKmA03WISQctgo",
  authDomain: "tablica-web.firebaseapp.com",
  databaseURL: "https://tablica-web-default-rtdb.firebaseio.com",
  projectId: "tablica-web"
});
const db = firebase.database();
const pagesRef = db.ref('pages');
const cursorsRef = db.ref('cursors');

// ---------------- Canvas ----------------
const canvas = document.getElementById("canvas");
const ctx = canvas.getContext("2d");

let drawMode = 'draw';
let drawing = false;
let color = 'black';
let size = 5;

let objects = [];
let selectedObjects = [];
let currentPage = null;

let draggingObject = null;
let dragOffsetX = 0;
let dragOffsetY = 0;

let dragHandle = null;
let dragStart = null;

let lastMousePos = null;
let isShift = false;

const userId = 'user_' + Math.random().toString(36).slice(2);

// ---------------- Cursor ----------------
function updateCursor(){
  canvas.style.cursor = drawMode === 'draw' ? 'none' : 'default';
}

// ---------------- Resize ----------------
function resizeCanvas(){
  canvas.width = window.innerWidth;
  canvas.height = window.innerHeight - 50;
  redraw();
}
window.addEventListener('resize', resizeCanvas);

// ---------------- Pages ----------------
let pages = [];
function loadPages(){
  pagesRef.on('value', snap=>{
    pages = snap.val() || [];
    if(!currentPage && pages.length) currentPage = pages[0].id;
    updatePageSelector();
    loadObjects();
  });
}
function updatePageSelector(){
  const sel = document.getElementById('pageSelector');
  sel.innerHTML = '';
  pages.forEach(p=>{
    const o = document.createElement('option');
    o.value = p.id;
    o.text = p.name;
    if(p.id === currentPage) o.selected = true;
    sel.appendChild(o);
  });
  document.getElementById('pageName').textContent =
    pages.find(p=>p.id===currentPage)?.name || '';
}
function addPage(){
  const name = prompt("Nazwa strony","Strona "+(pages.length+1));
  if(!name) return;
  const id = 'page_' + Date.now();
  pages.push({id,name});
  pagesRef.set(pages);
  currentPage = id;
}
function deletePage(){
  if(!currentPage || !confirm("Usunąć stronę?")) return;
  pages = pages.filter(p=>p.id!==currentPage);
  pagesRef.set(pages);
  db.ref('objects/'+currentPage).remove();
  currentPage = pages[0]?.id || null;
}
function renamePage(){
  const p = pages.find(p=>p.id===currentPage);
  const n = prompt("Nowa nazwa",p.name);
  if(n){ p.name=n; pagesRef.set(pages); }
}
function clearPage(){
  if(confirm("Wyczyścić stronę?")){
    objects = [];
    saveObjects();
  }
}
function switchPage(id){
  currentPage = id;
  loadObjects();
}
function loadObjects(){
  if(!currentPage) return;
  db.ref('objects/'+currentPage).on('value', snap=>{
    objects = snap.val() || [];
    redraw();
  });
}
function saveObjects(){
  if(currentPage) db.ref('objects/'+currentPage).set(objects);
}

// ---------------- Mouse ----------------
canvas.addEventListener('mousedown', e=>{
  const r = canvas.getBoundingClientRect();
  const x = e.clientX - r.left;
  const y = e.clientY - r.top;

  // handle scale / rotate
  for(let o of selectedObjects){
    for(let h of getHandles(o)){
      if(Math.abs(x-h.x)<6 && Math.abs(y-h.y)<6){
        dragHandle = {o, type:h.type};
        dragStart = {x,y,scale:o.scaleX,rot:o.rotation};
        return;
      }
    }
  }

  if(drawMode === 'draw'){
    drawing = true;
    objects.push({type:'line',color,size,points:[{x,y}]});
    return;
  }

  for(let o of objects){
    if(o.type==='image'){
      const cx=o.x+o.w/2, cy=o.y+o.h/2;
      if(Math.abs(x-cx)<=o.w*o.scaleX/2 && Math.abs(y-cy)<=o.h*o.scaleY/2){
        selectedObjects=[o]; o.selected=true;
        draggingObject=o;
        dragOffsetX=x-cx; dragOffsetY=y-cy;
        redraw(); return;
      }
    }
  }
  selectedObjects=[]; objects.forEach(o=>o.selected=false);
});

canvas.addEventListener('mousemove', e=>{
  const r = canvas.getBoundingClientRect();
  const x = e.clientX - r.left;
  const y = e.clientY - r.top;
  lastMousePos={x,y};

  if(dragHandle){
    const o=dragHandle.o;
    if(dragHandle.type==='scale'){
      const cx=o.x+o.w/2, cy=o.y+o.h/2;
      const s=Math.hypot(x-cx,y-cy)/Math.hypot(dragStart.x-cx,dragStart.y-cy);
      o.scaleX=o.scaleY=Math.max(0.1,dragStart.scale*s);
    }
    if(dragHandle.type==='rotate'){
      o.rotation=dragStart.rot+(x-dragStart.x);
    }
    redraw(); return;
  }

  if(draggingObject){
    draggingObject.x=x-draggingObject.w/2-dragOffsetX;
    draggingObject.y=y-draggingObject.h/2-dragOffsetY;
    redraw(); return;
  }

  if(drawing){
    const l=objects.at(-1);
    l.points.push({x,y});
    redraw();
  }
});

canvas.addEventListener('mouseup', ()=>{
  drawing=false; draggingObject=null; dragHandle=null;
  saveObjects();
});

// ---------------- Keys ----------------
window.addEventListener('keydown', e=>{
  if(e.key==='Delete'){
    objects=objects.filter(o=>!o.selected);
    saveObjects(); redraw();
  }
});

// ---------------- Utils ----------------
function setDrawMode(m){ drawMode=m; updateCursor(); }
function setColor(c){ color=c; }
function setSize(s){ size=parseInt(s); }
function undo(){ objects.pop(); saveObjects(); redraw(); }

function addImage(file){
  const r=new FileReader();
  r.onload=e=>{
    const i=new Image();
    i.onload=()=>{ objects.push({type:'image',img:e.target.result,x:50,y:50,w:i.width/2,h:i.height/2,scaleX:1,scaleY:1,rotation:0}); saveObjects(); redraw(); };
    i.src=e.target.result;
  };
  r.readAsDataURL(file);
}

function getHandles(o){
  if(o.type!=='image') return [];
  const cx=o.x+o.w/2, cy=o.y+o.h/2;
  return [
    {x:cx+o.w*o.scaleX/2,y:cy,type:'scale'},
    {x:cx,y:cy-o.h*o.scaleY/2-20,type:'rotate'}
  ];
}

// ---------------- Redraw ----------------
function redraw(){
  ctx.fillStyle='#fff'; ctx.fillRect(0,0,canvas.width,canvas.height);
  objects.forEach(o=>{
    ctx.save();
    if(o.type==='line'){
      ctx.beginPath();
      o.points.forEach((p,i)=>i?ctx.lineTo(p.x,p.y):ctx.moveTo(p.x,p.y));
      ctx.strokeStyle=o.color; ctx.lineWidth=o.size; ctx.stroke();
    }
    if(o.type==='image'){
      ctx.translate(o.x+o.w/2,o.y+o.h/2);
      ctx.rotate(o.rotation*Math.PI/180);
      ctx.scale(o.scaleX,o.scaleY);
      const img=new Image(); img.src=o.img;
      ctx.drawImage(img,-o.w/2,-o.h/2,o.w,o.h);
    }
    ctx.restore();
    if(o.selected){
      getHandles(o).forEach(h=>{
        ctx.fillStyle='red';
        ctx.fillRect(h.x-4,h.y-4,8,8);
      });
    }
  });

  if(drawMode==='draw' && lastMousePos){
    ctx.beginPath();
    ctx.arc(lastMousePos.x,lastMousePos.y,size/2,0,Math.PI*2);
    ctx.fillStyle=color;
    ctx.fill();
  }
}

resizeCanvas();
updateCursor();
loadPages();
</script>

</body>
</html>
