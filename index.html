<!DOCTYPE html>
<html lang="pl">
<head>
<meta charset="UTF-8">
<title>Tablica Online Realtime - Select & Resize</title>
<style>
  body { margin:0; overflow:hidden; }
  #toolbar {
    position: fixed; top:0; left:0; right:0; height:50px;
    background:#ddd; display:flex; align-items:center; padding:5px; z-index:100;
  }
  canvas { position:absolute; top:50px; left:0; cursor:crosshair; }
  button, input { margin-right:5px; }
</style>
</head>
<body>

<div id="toolbar">
  <button onclick="setDrawMode('draw')">Rysowanie</button>
  <button onclick="setDrawMode('select')">Zaznaczanie</button>
  <button onclick="setColor('black')">Czarny</button>
  <button onclick="setColor('red')">Czerwony</button>
  <button onclick="setColor('blue')">Niebieski</button>
  <label>Grubość:</label>
  <input type="range" id="size" min="1" max="50" value="5" onchange="setSize(this.value)">
  <button onclick="undo()">Cofnij</button>
  <button onclick="switchPage(1)">Strona 1</button>
  <button onclick="switchPage(2)">Strona 2</button>
  <button onclick="savePDF()">Zapisz do PDF</button>
  <input type="file" id="imgUpload" onchange="addImage(this.files[0])">
</div>

<canvas id="canvas"></canvas>

<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<script>
// -------------------- Firebase config --------------------
const firebaseConfig = {
  apiKey: "AIzaSyAU-m6n4AURX1VQL6BvKQKmA03WISQctgo",
  authDomain: "tablica-web.firebaseapp.com",
  databaseURL: "https://tablica-web-default-rtdb.firebaseio.com",
  projectId: "tablica-web",
  storageBucket: "tablica-web.appspot.com",
  messagingSenderId: "497248912756",
  appId: "1:497248912756:web:45894617e7de8bcdf15821"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

// -------------------- Canvas setup --------------------
const canvas = document.getElementById("canvas");
const ctx = canvas.getContext("2d");
let drawMode = 'draw'; // draw / select
let drawing=false, color="black", size=5;
let startX, startY;
let objects=[]; 
let currentPage=1;
let isShift=false;
let selectedObject = null;
let offsetX=0, offsetY=0;
let resizeHandle = null;

// -------------------- Resize & Grid --------------------
function resizeCanvas(){
  canvas.width = window.innerWidth;
  canvas.height = window.innerHeight - 50;
  redraw();
}
window.addEventListener('resize', resizeCanvas);

function drawGrid(){
  ctx.clearRect(0,0,canvas.width,canvas.height);
  const spacing = 25;
  ctx.strokeStyle = "#eee";
  ctx.lineWidth = 1;
  for(let x=0;x<canvas.width;x+=spacing){ctx.beginPath();ctx.moveTo(x,0);ctx.lineTo(x,canvas.height);ctx.stroke();}
  for(let y=0;y<canvas.height;y+=spacing){ctx.beginPath();ctx.moveTo(0,y);ctx.lineTo(canvas.width,y);ctx.stroke();}
}

// -------------------- Firebase --------------------
const objectsRef = db.ref('objects');
objectsRef.on('value', snapshot=>{
  const all = snapshot.val() || [];
  objects = all.filter(o=>o.page===currentPage);
  redraw();
});

function saveObjects(){ objectsRef.set(objects); }

// -------------------- Cursor --------------------
const userId = 'user_' + Math.floor(Math.random()*1000000);
const cursorsRef = db.ref('cursors');
let cursors = {};

canvas.addEventListener("mousemove", e=>{
  const rect = canvas.getBoundingClientRect();
  const x = e.clientX - rect.left;
  const y = e.clientY - rect.top;

  cursorsRef.child(userId).set({x, y});

  if(drawMode==='draw' && drawing && !selectedObject){
    let obj = objects[objects.length-1];
    if(obj.type==='line'){
      if(isShift){
        obj.points.splice(1,obj.points.length-1);
        obj.points.push({x:x,y:y});
      } else {
        obj.points.push({x:x,y:y});
      }
      redraw();
    }
  }

  if(selectedObject){
    if(selectedObject.isDragging){
      selectedObject.x = x - offsetX;
      selectedObject.y = y - offsetY;
      redraw();
    }
    if(resizeHandle){
      const dx = x - startX;
      const dy = y - startY;
      selectedObject.w = Math.max(10, selectedObject.startW + dx);
      selectedObject.h = Math.max(10, selectedObject.startH + dy);
      redraw();
    }
  }
});

cursorsRef.on('value', snapshot=>{
  cursors = snapshot.val() || {};
  redraw();
});

function drawCursors(){
  for(let key in cursors){
    const c = cursors[key];
    ctx.beginPath();
    ctx.arc(c.x,c.y,5,0,Math.PI*2);
    ctx.fillStyle = key===userId?'green':'red';
    ctx.fill();
  }
}

// -------------------- Mouse --------------------
canvas.addEventListener("mousedown", e=>{
  const rect = canvas.getBoundingClientRect();
  const x = e.clientX - rect.left;
  const y = e.clientY - rect.top;
  selectedObject = null;
  resizeHandle = null;

  if(drawMode==='select'){
    for(let i=objects.length-1;i>=0;i--){
      const obj = objects[i];
      if(obj.type==='image'){
        // uchwyt prawy dolny
        if(x>=obj.x+obj.w-10 && x<=obj.x+obj.w && y>=obj.y+obj.h-10 && y<=obj.y+obj.h){
          selectedObject=obj;
          resizeHandle=true;
          selectedObject.startW=obj.w;
          selectedObject.startH=obj.h;
          startX=x; startY=y;
          return;
        }
        if(x>=obj.x && x<=obj.x+obj.w && y>=obj.y && y<=obj.y+obj.h){
          selectedObject=obj;
          selectedObject.isDragging=true;
          offsetX = x - obj.x;
          offsetY = y - obj.y;
          redraw();
          return;
        }
      }
      if(obj.type==='line'){
        // prosta metoda zaznaczania całej linii
        const minX=Math.min(...obj.points.map(p=>p.x));
        const maxX=Math.max(...obj.points.map(p=>p.x));
        const minY=Math.min(...obj.points.map(p=>p.y));
        const maxY=Math.max(...obj.points.map(p=>p.y));
        if(x>=minX && x<=maxX && y>=minY && y<=maxY){
          selectedObject=obj;
          redraw();
          return;
        }
      }
    }
  }

  if(drawMode==='draw'){
    drawing=true;
    startX = x;
    startY = y;
    const line = {type:'line', color:color, size:size, points:[{x:startX,y:startY}], page:currentPage};
    objects.push(line);
  }
});

canvas.addEventListener("mouseup", e=>{
  drawing=false;
  if(selectedObject){
    selectedObject.isDragging=false;
    resizeHandle=null;
  }
  saveObjects();
});
canvas.addEventListener("mouseleave", e=>{
  drawing=false;
  if(selectedObject){
    selectedObject.isDragging=false;
    resizeHandle=null;
  }
  saveObjects();
});

// -------------------- Toolbar --------------------
function setDrawMode(mode){
  drawMode=mode;
  selectedObject=null;
  redraw();
}
function setColor(c){ color=c; }
function setSize(s){ size=parseInt(s); }
function undo(){ objects.pop(); saveObjects(); redraw(); }

function switchPage(page){
  currentPage = page;
  objectsRef.on('value', snapshot=>{
    const all = snapshot.val() || [];
    objects = all.filter(o=>o.page===currentPage);
    redraw();
  });
}

// -------------------- Images --------------------
function addImage(file){
  const reader = new FileReader();
  reader.onload = function(e){
    const img = new Image();
    img.src = e.target.result;
    img.onload = function(){
      const w = img.width/2;
      const h = img.height/2;
      const obj = {type:'image', img:e.target.result, x:50, y:50, w:w, h:h, page:currentPage};
      objects.push(obj);
      saveObjects();
      redraw();
    }
  }
  reader.readAsDataURL(file);
}

// -------------------- Paste from clipboard --------------------
window.addEventListener('paste', e=>{
  const items = e.clipboardData.items;
  for(let i=0;i<items.length;i++){
    if(items[i].type.indexOf("image")!==-1){
      const blob = items[i].getAsFile();
      const reader = new FileReader();
      reader.onload = function(event){
        const img = new Image();
        img.src = event.target.result;
        img.onload = function(){
          const w = img.width/2;
          const h = img.height/2;
          const obj = {type:'image', img:event.target.result, x:50, y:50, w:w, h:h, page:currentPage};
          objects.push(obj);
          saveObjects();
          redraw();
        }
      }
      reader.readAsDataURL(blob);
    }
  }
});

// -------------------- Delete key --------------------
window.addEventListener('keydown', e=>{
  if(e.key==='Delete' && selectedObject){
    objects = objects.filter(o=>o!==selectedObject);
    selectedObject=null;
    saveObjects();
    redraw();
  }
  if(e.key==='Shift') isShift=true;
});
window.addEventListener('keyup', e=>{
  if(e.key==='Shift') isShift=false;
});

// -------------------- PDF --------------------
function savePDF(){
  html2canvas(canvas).then(canvasImg=>{
    const imgData = canvasImg.toDataURL('image/png');
    const pdf = new jspdf.jsPDF({orientation:'landscape',unit:'px',format:[canvas.width,canvas.height]});
    pdf.addImage(imgData,'PNG',0,0,canvas.width,canvas.height);
    pdf.save('tablica.pdf');
  });
}

// -------------------- Redraw --------------------
function redraw(){
  drawGrid();
  for(let obj of objects){
    if(obj.type==='line'){
      ctx.beginPath();
      ctx.moveTo(obj.points[0].x,obj.points[0].y);
      for(let p of obj.points) ctx.lineTo(p.x,p.y);
      ctx.strokeStyle = obj.color;
      ctx.lineWidth = obj.size;
      ctx.lineCap="round"; ctx.lineJoin="round";
      ctx.stroke();
      if(selectedObject===obj){
        const minX=Math.min(...obj.points.map(p=>p.x));
        const maxX=Math.max(...obj.points.map(p=>p.x));
        const minY=Math.min(...obj.points.map(p=>p.y));
        const maxY=Math.max(...obj.points.map(p=>p.y));
        ctx.strokeStyle='blue';
        ctx.lineWidth=2;
        ctx.strokeRect(minX,minY,maxX-minX,maxY-minY);
      }
    } else if(obj.type==='image'){
      ctx.drawImage(obj.img instanceof Image?obj.img:(()=>{const i=new Image();i.src=obj.img;return i})(), obj.x,obj.y,obj.w,obj.h);
      if(selectedObject===obj){
        ctx.strokeStyle='blue';
        ctx.lineWidth=2;
        ctx.strokeRect(obj.x,obj.y,obj.w,obj.h);
        // róg skalowania
        ctx.fillStyle='white';
        ctx.fillRect(obj.x+obj.w-10,obj.y+obj.h-10,10,10);
        ctx.strokeRect(obj.x+obj.w-10,obj.y+obj.h-10,10,10);
      }
    }
  }
  drawCursors();
}

resizeCanvas();
</script>
</body>
</html>
